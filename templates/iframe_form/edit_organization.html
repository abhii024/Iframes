<!-- edit_organization.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Form Editor</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-edit"></i> Form Editor: {{ organization.name }}</h1>
            <a href="{% url 'organization_list' %}" class="back-btn" id="back-to-list">
                <i class="fas fa-arrow-left"></i> Back to Organizations
            </a>
        </header>
        
        <div class="editor-container">
            <div class="fields-panel">
                <h2>Field Types</h2>
                <div class="field-types">
                {% for key, field in field_types.items %}
                    <div class="field-type" draggable="true" data-type="{{ key }}">
                        <i class="{{ field.icon }}"></i>
                        <span>{{ field.label }}</span>
                    </div>
                {% endfor %}
            </div>

            </div>
            
            <div class="editor-panel">
                <div class="form-preview" id="preview-container">
                    <h3>Form Preview</h3>
                    {% if organization.form_fields %}
                        {% for field in organization.form_fields %}
                            <div class="preview-field" id="field-{{ forloop.counter }}" data-type="{{ field.type }}">
                                {% if field.type == 'text' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        <input type="text" placeholder="{{ field.placeholder }}" class="{{ field.css_class }}">
                                    </div>
                                {% elif field.type == 'email' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        <input type="email" placeholder="{{ field.placeholder }}" class="{{ field.css_class }}">
                                    </div>
                                {% elif field.type == 'number' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        <input type="number" placeholder="{{ field.placeholder }}" class="{{ field.css_class }}">
                                    </div>
                                {% elif field.type == 'phone' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        <input type="tel" placeholder="{{ field.placeholder }}" class="{{ field.css_class }}">
                                    </div>
                                {% elif field.type == 'textarea' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        <textarea placeholder="{{ field.placeholder }}" class="{{ field.css_class }}"></textarea>
                                    </div>
                                {% elif field.type == 'select' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        <select class="{{ field.css_class }}">
                                            <option value="">Select an option</option>
                                            {% for option in field.options %}
                                                <option value="{{ option }}">{{ option }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                {% elif field.type == 'multiselect' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        <select multiple class="{{ field.css_class }}">
                                            {% for option in field.options %}
                                                <option value="{{ option }}">{{ option }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                {% elif field.type == 'radio' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        {% for option in field.options %}
                                            <div class="radio-field">
                                                <input type="radio" name="{{ field.name }}" value="{{ option }}">
                                                <label>{{ option }}</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% elif field.type == 'checkbox' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <div class="checkbox-field">
                                            <input type="checkbox" name="{{ field.name }}">
                                            <label>{{ field.label }}</label>
                                        </div>
                                    </div>
                                {% elif field.type == 'multicheckbox' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        {% for option in field.options %}
                                            <div class="checkbox-field">
                                                <input type="checkbox" name="{{ field.name }}[]" value="{{ option }}">
                                                <label>{{ option }}</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% elif field.type == 'date' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        <input type="date" class="{{ field.css_class }}">
                                    </div>
                                {% elif field.type == 'time' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        <input type="time" class="{{ field.css_class }}">
                                    </div>
                                {% elif field.type == 'url' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <label>{{ field.label }}</label>
                                        <input type="url" placeholder="{{ field.placeholder }}" class="{{ field.css_class }}">
                                    </div>
                                {% elif field.type == 'html' %}
                                    <div class="form-field html-content {{ field.css_class }}">
                                        {{ field.html|safe }}
                                    </div>
                                {% elif field.type == 'consent' %}
                                    <div class="form-field {% if field.required %}required{% endif %}">
                                        <div class="checkbox-field">
                                            <input type="checkbox" name="{{ field.name }}">
                                            <label>{{ field.label }}</label>
                                        </div>
                                    </div>
                                {% endif %}
                                <div class="field-actions">
                                    <button class="edit-field" title="Edit"><i class="fas fa-edit"></i></button>
                                    <button class="remove-field" title="Remove"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>Drag and drop fields from the left panel to build your form</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="field-properties" id="properties-container">
                <h2>Field Properties</h2>
                <div class="no-field-selected">
                    <i class="fas fa-mouse-pointer"></i>
                    <p>Select a field to edit its properties</p>
                </div>
            </div>
        </div>
        
        <div class="editor-actions">
            <button class="btn btn-secondary" id="preview-btn">
                <i class="fas fa-eye"></i> Preview Form
            </button>
            <button class="btn btn-secondary" id="view-submissions-btn">
                <i class="fas fa-database"></i> View Submissions
            </button>
            <button class="btn btn-primary" id="save-btn">
                <i class="fas fa-save"></i> Save Form
            </button>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal" id="preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Form Preview</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div id="preview-form-container"></div>
        </div>
    </div>

    <!-- Submissions Modal -->
    <div class="modal" id="submissions-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Form Submissions</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div id="submissions-container"></div>
        </div>
    </div>

    <!-- Submission Details Modal -->
    <div class="modal" id="submission-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Submission Details</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div id="submission-details-container"></div>
        </div>
    </div>

    <form id="save-form" method="POST" action="{% url 'edit_organization' organization.id %}">
        {% csrf_token %}
        <input type="hidden" name="form_fields" id="form-fields-input">
        <input type="hidden" name="form_style" id="form-style-input" value="{{ organization.form_style }}">
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fieldTypes = document.querySelectorAll('.field-type');
            const previewContainer = document.getElementById('preview-container');
            const propertiesContainer = document.getElementById('properties-container');
            const previewModal = document.getElementById('preview-modal');
            const previewFormContainer = document.getElementById('preview-form-container');
            const submissionsModal = document.getElementById('submissions-modal');
            const submissionsContainer = document.getElementById('submissions-container');
            const submissionDetailsModal = document.getElementById('submission-details-modal');
            const submissionDetailsContainer = document.getElementById('submission-details-container');
            const modalCloseButtons = document.querySelectorAll('.modal-close');
            const formFieldsInput = document.getElementById('form-fields-input');
            const saveForm = document.getElementById('save-form');
            
            let currentField = null;
            let fieldCounter = "{{ organization.form_fields|length|default:0 }}" + 1;
            let fieldsData = {};
            
            // Initialize fields data from existing form fields
            {% if organization.form_fields %}
                {% for field in organization.form_fields %}
                    fieldsData['field-{{ forloop.counter }}'] = {
                        type: '{{ field.type }}',
                        label: '{{ field.label|escapejs }}',
                        name: '{{ field.name|escapejs }}',
                        required: {% if field.required %}true{% else %}false{% endif %},
                        placeholder: '{{ field.placeholder|escapejs }}',
                        css_class: '{{ field.css_class|escapejs }}',
                        maxlength: '{{ field.maxlength|escapejs }}',
                        options: {{ field.options|safe }},
                        html: `{{ field.html|safe|escapejs }}`
                    };
                {% endfor %}
            {% endif %}
            
            // Field templates for preview
            const fieldTemplates = {
                text: '<div class="form-field"><label>Text Field</label><input type="text" placeholder="Enter text"></div>',
                email: '<div class="form-field"><label>Email Field</label><input type="email" placeholder="Enter email"></div>',
                number: '<div class="form-field"><label>Number Field</label><input type="number" placeholder="Enter number"></div>',
                phone: '<div class="form-field"><label>Phone Field</label><input type="tel" placeholder="Enter phone number"></div>',
                textarea: '<div class="form-field"><label>Text Area</label><textarea placeholder="Enter text"></textarea></div>',
                select: '<div class="form-field"><label>Dropdown</label><select><option value="">Select an option</option><option value="option1">Option 1</option><option value="option2">Option 2</option></select></div>',
                multiselect: '<div class="form-field"><label>Multi Select</label><select multiple><option value="option1">Option 1</option><option value="option2">Option 2</option><option value="option3">Option 3</option></select></div>',
                radio: `<div class="form-field">
                    <label>Radio Buttons</label>
                    <div class="radio-field"><input type="radio" name="radio-group"> <label>Option 1</label></div>
                    <div class="radio-field"><input type="radio" name="radio-group"> <label>Option 2</label></div>
                </div>`,
                checkbox: '<div class="form-field"><div class="checkbox-field"><input type="checkbox"> <label>Checkbox</label></div></div>',
                multicheckbox: `<div class="form-field">
                    <label>Multi Checkbox</label>
                    <div class="checkbox-field"><input type="checkbox"> <label>Option 1</label></div>
                    <div class="checkbox-field"><input type="checkbox"> <label>Option 2</label></div>
                    <div class="checkbox-field"><input type="checkbox"> <label>Option 3</label></div>
                </div>`,
                date: '<div class="form-field"><label>Date</label><input type="date"></div>',
                time: '<div class="form-field"><label>Time</label><input type="time"></div>',
                url: '<div class="form-field"><label>Website URL</label><input type="url" placeholder="https://example.com"></div>',
                html: '<div class="form-field html-content"><p>HTML Content</p></div>',
                consent: '<div class="form-field"><div class="checkbox-field"><input type="checkbox"> <label>I agree to the terms and conditions</label></div></div>'
            };
            
            // Properties templates for each field type
            const propertiesTemplates = {
                text: `
                    <div class="property-group">
                        <h3>Basic Properties</h3>
                        <div class="form-group">
                            <label for="field-label">Label</label>
                            <input type="text" id="field-label" value="Text Field">
                        </div>
                        <div class="form-group">
                            <label for="field-name">Field Name</label>
                            <input type="text" id="field-name" value="text_field">
                        </div>
                        <div class="form-group">
                            <label for="field-placeholder">Placeholder</label>
                            <input type="text" id="field-placeholder" value="Enter text">
                        </div>
                        <div class="form-group">
                            <label for="field-maxlength">Max Length</label>
                            <input type="number" id="field-maxlength" value="">
                        </div>
                    </div>
                    <div class="property-group">
                        <h3>Validation</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="field-required"> Required Field</label>
                        </div>
                    </div>
                `,
                email: `
                    <div class="property-group">
                        <h3>Basic Properties</h3>
                        <div class="form-group">
                            <label for="field-label">Label</label>
                            <input type="text" id="field-label" value="Email Field">
                        </div>
                        <div class="form-group">
                            <label for="field-name">Field Name</label>
                            <input type="text" id="field-name" value="email">
                        </div>
                        <div class="form-group">
                            <label for="field-placeholder">Placeholder</label>
                            <input type="text" id="field-placeholder" value="Enter email">
                        </div>
                    </div>
                    <div class="property-group">
                        <h3>Validation</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="field-required" checked> Required Field</label>
                        </div>
                    </div>
                `,
                select: `
                    <div class="property-group">
                        <h3>Basic Properties</h3>
                        <div class="form-group">
                            <label for="field-label">Label</label>
                            <input type="text" id="field-label" value="Dropdown">
                        </div>
                        <div class="form-group">
                            <label for="field-name">Field Name</label>
                            <input type="text" id="field-name" value="dropdown">
                        </div>
                    </div>
                    <div class="property-group">
                        <h3>Options</h3>
                        <div class="options-list" id="options-container">
                            <div class="option-item">
                                <input type="text" placeholder="Option value" value="Option 1">
                                <button class="remove-option">&times;</button>
                            </div>
                            <div class="option-item">
                                <input type="text" placeholder="Option value" value="Option 2">
                                <button class="remove-option">&times;</button>
                            </div>
                        </div>
                        <button class="add-option" id="add-option">Add Option</button>
                    </div>
                    <div class="property-group">
                        <h3>Validation</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="field-required"> Required Field</label>
                        </div>
                    </div>
                `,
                radio: `
                    <div class="property-group">
                        <h3>Basic Properties</h3>
                        <div class="form-group">
                            <label for="field-label">Label</label>
                            <input type="text" id="field-label" value="Radio Buttons">
                        </div>
                        <div class="form-group">
                            <label for="field-name">Field Name</label>
                            <input type="text" id="field-name" value="radio_buttons">
                        </div>
                    </div>
                    <div class="property-group">
                        <h3>Options</h3>
                        <div class="options-list" id="options-container">
                            <div class="option-item">
                                <input type="text" placeholder="Option value" value="Option 1">
                                <button class="remove-option">&times;</button>
                            </div>
                            <div class="option-item">
                                <input type="text" placeholder="Option value" value="Option 2">
                                <button class="remove-option">&times;</button>
                            </div>
                        </div>
                        <button class="add-option" id="add-option">Add Option</button>
                    </div>
                    <div class="property-group">
                        <h3>Validation</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="field-required"> Required Field</label>
                        </div>
                    </div>
                `,
                checkbox: `
                    <div class="property-group">
                        <h3>Basic Properties</h3>
                        <div class="form-group">
                            <label for="field-label">Label</label>
                            <input type="text" id="field-label" value="Checkbox">
                        </div>
                        <div class="form-group">
                            <label for="field-name">Field Name</label>
                            <input type="text" id="field-name" value="checkbox">
                        </div>
                    </div>
                    <div class="property-group">
                        <h3>Validation</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="field-required"> Required Field</label>
                        </div>
                    </div>
                `,
                multicheckbox: `
                    <div class="property-group">
                        <h3>Basic Properties</h3>
                        <div class="form-group">
                            <label for="field-label">Label</label>
                            <input type="text" id="field-label" value="Multi Checkbox">
                        </div>
                        <div class="form-group">
                            <label for="field-name">Field Name</label>
                            <input type="text" id="field-name" value="multi_checkbox">
                        </div>
                    </div>
                    <div class="property-group">
                        <h3>Options</h3>
                        <div class="options-list" id="options-container">
                            <div class="option-item">
                                <input type="text" placeholder="Option value" value="Option 1">
                                <button class="remove-option">&times;</button>
                            </div>
                            <div class="option-item">
                                <input type="text" placeholder="Option value" value="Option 2">
                                <button class="remove-option">&times;</button>
                            </div>
                        </div>
                        <button class="add-option" id="add-option">Add Option</button>
                    </div>
                    <div class="property-group">
                        <h3>Validation</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="field-required"> Required Field</label>
                        </div>
                    </div>
                `,
                html: `
                    <div class="property-group">
                        <h3>Basic Properties</h3>
                        <div class="form-group">
                            <label for="field-name">Field Name</label>
                            <input type="text" id="field-name" value="html_content">
                        </div>
                    </div>
                    <div class="property-group">
                        <h3>HTML Content</h3>
                        <div class="form-group">
                            <label for="field-html">HTML Code</label>
                            <textarea id="field-html"><p>HTML Content</p></textarea>
                        </div>
                    </div>
                `,
                consent: `
                    <div class="property-group">
                        <h3>Basic Properties</h3>
                        <div class="form-group">
                            <label for="field-label">Label</label>
                            <input type="text" id="field-label" value="I agree to the terms and conditions">
                        </div>
                        <div class="form-group">
                            <label for="field-name">Field Name</label>
                            <input type="text" id="field-name" value="consent">
                        </div>
                    </div>
                    <div class="property-group">
                        <h3>Validation</h3>
                        <div class="form-group">
                            <label><input type="checkbox" id="field-required" checked> Required Field</label>
                        </div>
                    </div>
                `
            };
            
            // Default properties template for field types without specific templates
            propertiesTemplates.default = `
                <div class="property-group">
                    <h3>Basic Properties</h3>
                    <div class="form-group">
                        <label for="field-label">Label</label>
                        <input type="text" id="field-label" value="Field">
                    </div>
                    <div class="form-group">
                        <label for="field-name">Field Name</label>
                        <input type="text" id="field-name" value="field">
                    </div>
                    <div class="form-group">
                        <label for="field-placeholder">Placeholder</label>
                        <input type="text" id="field-placeholder" value="">
                    </div>
                </div>
                <div class="property-group">
                    <h3>Validation</h3>
                    <div class="form-group">
                        <label><input type="checkbox" id="field-required"> Required Field</label>
                    </div>
                </div>
            `;
            
            // Add drag and drop functionality to field types
            fieldTypes.forEach(fieldType => {
                fieldType.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('field-type', this.getAttribute('data-type'));
                });
            });
            
            // Allow drop in preview container
            previewContainer.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            previewContainer.addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });
            
            // Handle drop in preview container
            previewContainer.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const fieldType = e.dataTransfer.getData('field-type');
                
                // Remove empty state if it exists
                if (previewContainer.querySelector('.empty-state')) {
                    previewContainer.innerHTML = '<h3>Form Preview</h3>';
                }
                
                // Create field element
                const fieldId = `field-${fieldCounter++}`;
                const fieldElement = document.createElement('div');
                fieldElement.className = 'preview-field';
                fieldElement.id = fieldId;
                fieldElement.setAttribute('data-type', fieldType);
                fieldElement.innerHTML = `
                    ${fieldTemplates[fieldType]}
                    <div class="field-actions">
                        <button class="edit-field" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="remove-field" title="Remove"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                
                previewContainer.appendChild(fieldElement);
                
                // Initialize field data
                fieldsData[fieldId] = {
                    type: fieldType,
                    label: fieldType.charAt(0).toUpperCase() + fieldType.slice(1) + ' Field',
                    name: fieldType + '_field',
                    required: false,
                    placeholder: 'Enter ' + fieldType,
                    options: fieldType === 'select' || fieldType === 'radio' || fieldType === 'multicheckbox' ? 
                        ['Option 1', 'Option 2'] : []
                };
                
                // Add event listeners to action buttons
                fieldElement.querySelector('.remove-field').addEventListener('click', function() {
                    fieldElement.remove();
                    delete fieldsData[fieldId];
                    
                    if (previewContainer.querySelectorAll('.preview-field').length === 0) {
                        showEmptyState();
                    }
                    if (currentField === fieldId) {
                        showNoFieldSelected();
                    }
                });
                
                fieldElement.addEventListener('click', function(e) {
                    if (!e.target.closest('.field-actions')) {
                        selectField(fieldId, fieldType);
                    }
                });
                
                // Select the new field
                selectField(fieldId, fieldType);
            });
            
            // Add event listeners to existing fields
            document.querySelectorAll('.preview-field').forEach(field => {
                const fieldId = field.id;
                const fieldType = field.getAttribute('data-type');
                
                field.querySelector('.remove-field').addEventListener('click', function() {
                    field.remove();
                    delete fieldsData[fieldId];
                    
                    if (previewContainer.querySelectorAll('.preview-field').length === 0) {
                        showEmptyState();
                    }
                    if (currentField === fieldId) {
                        showNoFieldSelected();
                    }
                });
                
                field.addEventListener('click', function(e) {
                    if (!e.target.closest('.field-actions')) {
                        selectField(fieldId, fieldType);
                    }
                });
            });
            
            // Function to show empty state
            function showEmptyState() {
                previewContainer.innerHTML = `
                    <h3>Form Preview</h3>
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Drag and drop fields from the left panel to build your form</p>
                    </div>
                `;
            }
            
            // Function to show no field selected
            function showNoFieldSelected() {
                propertiesContainer.innerHTML = `
                    <h2>Field Properties</h2>
                    <div class="no-field-selected">
                        <i class="fas fa-mouse-pointer"></i>
                        <p>Select a field to edit its properties</p>
                    </div>
                `;
                currentField = null;
            }
            
            // Function to select a field
            function selectField(fieldId, fieldType) {
                currentField = fieldId;
                
                // Remove selected class from all fields
                document.querySelectorAll('.preview-field').forEach(field => {
                    field.classList.remove('selected');
                });
                
                // Add selected class to current field
                document.getElementById(fieldId).classList.add('selected');
                
                // Show properties for the selected field
                const template = propertiesTemplates[fieldType] || propertiesTemplates.default;
                propertiesContainer.innerHTML = `
                    <h2>Field Properties</h2>
                    <div class="property-group">
                        <h3>Field Type</h3>
                        <div class="form-group">
                            <span>${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)}</span>
                        </div>
                    </div>
                    ${template}
                    <div class="property-group">
                        <h3>Advanced</h3>
                        <div class="form-group">
                            <label for="field-css">Custom CSS Class</label>
                            <input type="text" id="field-css" value="">
                        </div>
                    </div>
                    <div class="property-group">
                        <button class="btn btn-primary" id="update-field">Update Field</button>
                    </div>
                `;
                
                // Populate with existing data if available
                if (fieldsData[fieldId]) {
                    const data = fieldsData[fieldId];
                    if (document.getElementById('field-label')) document.getElementById('field-label').value = data.label;
                    if (document.getElementById('field-name')) document.getElementById('field-name').value = data.name;
                    if (document.getElementById('field-placeholder')) document.getElementById('field-placeholder').value = data.placeholder;
                    if (document.getElementById('field-required')) document.getElementById('field-required').checked = data.required;
                    if (document.getElementById('field-html') && data.html) document.getElementById('field-html').value = data.html;
                    if (document.getElementById('field-maxlength')) document.getElementById('field-maxlength').value = data.maxlength || '';
                    if (document.getElementById('field-css')) document.getElementById('field-css').value = data.css_class || '';
                    
                    // Handle options for select, radio, and checkbox fields
                    if ((fieldType === 'select' || fieldType === 'radio' || fieldType === 'multicheckbox') && data.options) {
                        const optionsContainer = document.getElementById('options-container');
                        optionsContainer.innerHTML = '';
                        
                        data.options.forEach(option => {
                            const optionItem = document.createElement('div');
                            optionItem.className = 'option-item';
                            optionItem.innerHTML = `
                                <input type="text" placeholder="Option value" value="${option}">
                                <button class="remove-option">&times;</button>
                            `;
                            optionsContainer.appendChild(optionItem);
                        });
                        
                        // Add event listeners to remove buttons
                        optionsContainer.querySelectorAll('.remove-option').forEach(button => {
                            button.addEventListener('click', function() {
                                this.parentElement.remove();
                            });
                        });
                    }
                }
                
                // Add event listener for adding options
                if (document.getElementById('add-option')) {
                    document.getElementById('add-option').addEventListener('click', function() {
                        const optionsContainer = document.getElementById('options-container');
                        const optionItem = document.createElement('div');
                        optionItem.className = 'option-item';
                        optionItem.innerHTML = `
                            <input type="text" placeholder="Option value">
                            <button class="remove-option">&times;</button>
                        `;
                        optionsContainer.appendChild(optionItem);
                        
                        // Add event listener to remove button
                        optionItem.querySelector('.remove-option').addEventListener('click', function() {
                            optionItem.remove();
                        });
                    });
                }
                
                // Add event listener to update button
                document.getElementById('update-field').addEventListener('click', function() {
                    updateField(fieldId, fieldType);
                });
            }
            
            // Function to update field with new properties
            function updateField(fieldId, fieldType) {
                const fieldData = {
                    type: fieldType,
                    label: document.getElementById('field-label') ? document.getElementById('field-label').value : '',
                    name: document.getElementById('field-name') ? document.getElementById('field-name').value : '',
                    placeholder: document.getElementById('field-placeholder') ? document.getElementById('field-placeholder').value : '',
                    required: document.getElementById('field-required') ? document.getElementById('field-required').checked : false,
                    maxlength: document.getElementById('field-maxlength') ? document.getElementById('field-maxlength').value : '',
                    css_class: document.getElementById('field-css') ? document.getElementById('field-css').value : ''
                };
                
                // Handle HTML content
                if (fieldType === 'html' && document.getElementById('field-html')) {
                    fieldData.html = document.getElementById('field-html').value;
                }
                
                // Handle options for select, radio, and checkbox fields
                if (fieldType === 'select' || fieldType === 'radio' || fieldType === 'multicheckbox') {
                    fieldData.options = [];
                    const optionInputs = document.querySelectorAll('#options-container input');
                    optionInputs.forEach(input => {
                        if (input.value.trim() !== '') {
                            fieldData.options.push(input.value);
                        }
                    });
                }
                
                fieldsData[fieldId] = fieldData;
                
                // Update the preview
                const fieldElement = document.getElementById(fieldId);
                let newHtml = '';
                
                if (fieldType === 'text' || fieldType === 'email' || fieldType === 'number' || 
                    fieldType === 'phone' || fieldType === 'url' || fieldType === 'date' || fieldType === 'time') {
                    newHtml = `
                        <div class="form-field ${fieldData.required ? 'required' : ''}">
                            <label>${fieldData.label}</label>
                            <input type="${fieldType}" placeholder="${fieldData.placeholder}" 
                                class="${fieldData.css_class}" ${fieldData.maxlength ? `maxlength="${fieldData.maxlength}"` : ''}>
                        </div>
                    `;
                } else if (fieldType === 'textarea') {
                    newHtml = `
                        <div class="form-field ${fieldData.required ? 'required' : ''}">
                            <label>${fieldData.label}</label>
                            <textarea placeholder="${fieldData.placeholder}" class="${fieldData.css_class}"></textarea>
                        </div>
                    `;
                } else if (fieldType === 'select') {
                    let optionsHtml = '<option value="">Select an option</option>';
                    if (fieldData.options) {
                        fieldData.options.forEach(option => {
                            optionsHtml += `<option value="${option}">${option}</option>`;
                        });
                    }
                    newHtml = `
                        <div class="form-field ${fieldData.required ? 'required' : ''}">
                            <label>${fieldData.label}</label>
                            <select class="${fieldData.css_class}">
                                ${optionsHtml}
                            </select>
                        </div>
                    `;
                } else if (fieldType === 'multiselect') {
                    let optionsHtml = '';
                    if (fieldData.options) {
                        fieldData.options.forEach(option => {
                            optionsHtml += `<option value="${option}">${option}</option>`;
                        });
                    }
                    newHtml = `
                        <div class="form-field ${fieldData.required ? 'required' : ''}">
                            <label>${fieldData.label}</label>
                            <select multiple class="${fieldData.css_class}">
                                ${optionsHtml}
                            </select>
                        </div>
                    `;
                } else if (fieldType === 'radio') {
                    let optionsHtml = '';
                    if (fieldData.options) {
                        fieldData.options.forEach(option => {
                            optionsHtml += `
                                <div class="radio-field">
                                    <input type="radio" name="${fieldData.name}" value="${option}">
                                    <label>${option}</label>
                                </div>
                            `;
                        });
                    }
                    newHtml = `
                        <div class="form-field ${fieldData.required ? 'required' : ''}">
                            <label>${fieldData.label}</label>
                            ${optionsHtml}
                        </div>
                    `;
                } else if (fieldType === 'checkbox') {
                    newHtml = `
                        <div class="form-field ${fieldData.required ? 'required' : ''}">
                            <div class="checkbox-field">
                                <input type="checkbox" name="${fieldData.name}" class="${fieldData.css_class}">
                                <label>${fieldData.label}</label>
                            </div>
                        </div>
                    `;
                } else if (fieldType === 'multicheckbox') {
                    let optionsHtml = '';
                    if (fieldData.options) {
                        fieldData.options.forEach(option => {
                            optionsHtml += `
                                <div class="checkbox-field">
                                    <input type="checkbox" name="${fieldData.name}[]" value="${option}">
                                    <label>${option}</label>
                                </div>
                            `;
                        });
                    }
                    newHtml = `
                        <div class="form-field ${fieldData.required ? 'required' : ''}">
                            <label>${fieldData.label}</label>
                            ${optionsHtml}
                        </div>
                    `;
                } else if (fieldType === 'html') {
                    newHtml = `
                        <div class="form-field html-content ${fieldData.css_class}">
                            ${fieldData.html || '<p>HTML Content</p>'}
                        </div>
                    `;
                } else if (fieldType === 'consent') {
                    newHtml = `
                        <div class="form-field ${fieldData.required ? 'required' : ''}">
                            <div class="checkbox-field">
                                <input type="checkbox" name="${fieldData.name}" class="${fieldData.css_class}">
                                <label>${fieldData.label}</label>
                            </div>
                        </div>
                    `;
                } else {
                    newHtml = fieldTemplates[fieldType];
                }
                
                fieldElement.innerHTML = newHtml + `
                    <div class="field-actions">
                        <button class="edit-field" title="Edit"><i class="fas fa-edit"></i></button>
                        <button class="remove-field" title="Remove"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                
                // Reattach event listeners
                fieldElement.querySelector('.remove-field').addEventListener('click', function() {
                    fieldElement.remove();
                    delete fieldsData[fieldId];
                    
                    if (previewContainer.querySelectorAll('.preview-field').length === 0) {
                        showEmptyState();
                    }
                    if (currentField === fieldId) {
                        showNoFieldSelected();
                    }
                });
                
                fieldElement.addEventListener('click', function(e) {
                    if (!e.target.closest('.field-actions')) {
                        selectField(fieldId, fieldType);
                    }
                });
                
                alert('Field updated successfully!');
            }
            
            // Function to generate form data for storage
            function generateFormData() {
                const formData = [];
                for (const fieldId in fieldsData) {
                    formData.push(fieldsData[fieldId]);
                }
                return formData;
            }
            
            // Function to display the form for users to fill out
            function displayFormForUser(formData) {
                let formHtml = `
                    <div class="form-display-container">
                        <div class="form-display">
                            <h2>Contact Form</h2>
                            <form id="user-form">
                `;
                
                formData.forEach(field => {
                    if (field.type === 'text' || field.type === 'email' || field.type === 'number' || 
                        field.type === 'phone' || field.type === 'url' || field.type === 'date' || field.type === 'time') {
                        formHtml += `
                            <div class="form-field ${field.required ? 'required' : ''}">
                                <label for="${field.name}">${field.label}</label>
                                <input type="${field.type}" id="${field.name}" name="${field.name}" 
                                    placeholder="${field.placeholder || ''}" 
                                    ${field.required ? 'required' : ''}
                                    ${field.maxlength ? `maxlength="${field.maxlength}"` : ''}>
                            </div>
                        `;
                    } else if (field.type === 'textarea') {
                        formHtml += `
                            <div class="form-field ${field.required ? 'required' : ''}">
                                <label for="${field.name}">${field.label}</label>
                                <textarea id="${field.name}" name="${field.name}" 
                                    placeholder="${field.placeholder || ''}" 
                                    ${field.required ? 'required' : ''}></textarea>
                            </div>
                        `;
                    } else if (field.type === 'select') {
                        let optionsHtml = '<option value="">Select an option</option>';
                        if (field.options) {
                            field.options.forEach(option => {
                                optionsHtml += `<option value="${option}">${option}</option>`;
                            });
                        }
                        formHtml += `
                            <div class="form-field ${field.required ? 'required' : ''}">
                                <label for="${field.name}">${field.label}</label>
                                <select id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>
                                    ${optionsHtml}
                                </select>
                            </div>
                        `;
                    } else if (field.type === 'multiselect') {
                        let optionsHtml = '';
                        if (field.options) {
                            field.options.forEach(option => {
                                optionsHtml += `<option value="${option}">${option}</option>`;
                            });
                        }
                        formHtml += `
                            <div class="form-field ${field.required ? 'required' : ''}">
                                <label for="${field.name}">${field.label}</label>
                                <select multiple id="${field.name}" name="${field.name}" ${field.required ? 'required' : ''}>
                                    ${optionsHtml}
                                </select>
                            </div>
                        `;
                    } else if (field.type === 'radio') {
                        let optionsHtml = '';
                        if (field.options) {
                            field.options.forEach(option => {
                                optionsHtml += `
                                    <div class="radio-field">
                                        <input type="radio" id="${field.name}_${option}" name="${field.name}" value="${option}">
                                        <label for="${field.name}_${option}">${option}</label>
                                    </div>
                                `;
                            });
                        }
                        formHtml += `
                            <div class="form-field ${field.required ? 'required' : ''}">
                                <label>${field.label}</label>
                                ${optionsHtml}
                            </div>
                        `;
                    } else if (field.type === 'checkbox') {
                        formHtml += `
                            <div class="form-field ${field.required ? 'required' : ''}">
                                <div class="checkbox-field">
                                    <input type="checkbox" id="${field.name}" name="${field.name}" value="true" ${field.required ? 'required' : ''}>
                                    <label for="${field.name}">${field.label}</label>
                                </div>
                            </div>
                        `;
                    } else if (field.type === 'multicheckbox') {
                        let optionsHtml = '';
                        if (field.options) {
                            field.options.forEach(option => {
                                optionsHtml += `
                                    <div class="checkbox-field">
                                        <input type="checkbox" id="${field.name}_${option}" name="${field.name}[]" value="${option}">
                                        <label for="${field.name}_${option}">${option}</label>
                                    </div>
                                `;
                            });
                        }
                        formHtml += `
                            <div class="form-field ${field.required ? 'required' : ''}">
                                <label>${field.label}</label>
                                ${optionsHtml}
                            </div>
                        `;
                    } else if (field.type === 'html') {
                        formHtml += `
                            <div class="html-content">
                                ${field.html || ''}
                            </div>
                        `;
                    } else if (field.type === 'consent') {
                        formHtml += `
                            <div class="form-field ${field.required ? 'required' : ''}">
                                <div class="checkbox-field">
                                    <input type="checkbox" id="${field.name}" name="${field.name}" value="true" ${field.required ? 'required' : ''}>
                                    <label for="${field.name}">${field.label}</label>
                                </div>
                            </div>
                        `;
                    }
                });
                
                formHtml += `
                                <button type="submit" class="submit-btn">Submit Form</button>
                            </form>
                        </div>
                    </div>
                `;
                
                return formHtml;
            }
            
            // Initialize buttons
            document.getElementById('preview-btn').addEventListener('click', function() {
                const formData = generateFormData();
                previewFormContainer.innerHTML = displayFormForUser(formData);
                
                // Add event listener to the form
                const userForm = previewFormContainer.querySelector('#user-form');
                if (userForm) {
                    userForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        
                        // Show success message
                        previewFormContainer.innerHTML = `
                            <div class="success-message">
                                <i class="fas fa-check-circle"></i>
                                <h2>Form Submitted Successfully!</h2>
                                <p>Thank you for your submission.</p>
                            </div>
                        `;
                    });
                }
                
                previewModal.style.display = 'flex';
            });
            
            document.getElementById('save-btn').addEventListener('click', function() {
                const formData = generateFormData();
                formFieldsInput.value = JSON.stringify(formData);
                saveForm.submit();
            });
            
            // Close modals when clicking close button
            modalCloseButtons.forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
            
            // Initialize
            if (previewContainer.querySelectorAll('.preview-field').length === 0) {
                showEmptyState();
            }
            showNoFieldSelected();
        });
    </script>
</body>
</html>